<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="BookCafe_ProductManagemnet_Modify" width="1080" height="720" titletext="제품관리" oninit="BookCafe_ProductManagemnet_Modify_oninit">
    <Layouts>
      <Layout height="720" mobileorientation="landscape" width="1020">
        <Div id="Div00" taborder="7" left="1.76%" top="97" height="40" cssclass="main_nav" right="1.76%"/>
        <Static id="Static00" taborder="0" text="제품관리" left="1.86%" height="38" top="2.78%" width="128" cssclass="main_title"/>
        <Static id="Static01" taborder="8" text="분류" left="30" top="110" width="24" height="14"/>
        <Combo id="fir_category" taborder="1" text="" left="Static01:5" top="102" width="100" height="30" value="" index="-1" innerdataset="init_fir_code" codecolumn="FIR_CODE" datacolumn="FIR_NAME" border="1px solid #4F4537" onitemchanged="fir_category_onitemchanged" cssclass="combo_default"/>
        <Combo id="sec_category" taborder="2" top="102" width="100" height="30" value="" index="-1" text="" innerdataset="sec_code" codecolumn="SEC_CODE" datacolumn="SEC_NAME" left="fir_category:5" border="1px solid #4F4537" onitemchanged="sec_category_onitemchanged" cssclass="combo_default"/>
        <Grid id="Grid00" taborder="6" left="19" top="156" bottom="7.78%" right="21" binddataset="view_dtl" autofittype="col" border="1px solid #4F4537" oncelldblclick="Grid00_oncelldblclick" onsize="Grid00_onsize">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="20"/>
                <Column size="52"/>
                <Column size="70"/>
                <Column size="100"/>
                <Column size="160"/>
                <Column size="30"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="checkboxcontrol" edittype="checkbox" background="#FFF8EE" checkboxfalsevalue="N" checkboxtruevalue="Y" text="bind:CHK" cursor="auto"/>
                <Cell col="1" text="제품코드" background="#FFF8EE" textAlign="center" cursor="auto" verticalAlign="middle"/>
                <Cell col="2" text="분류" background="#FFF8EE" textAlign="center" cursor="auto" verticalAlign="middle"/>
                <Cell col="3" text="제품명" background="#FFF8EE" textAlign="center" cursor="auto" verticalAlign="middle"/>
                <Cell col="4" text="이미지경로" background="#FFF8EE"/>
                <Cell col="5" text="가격" background="#FFF8EE" textAlign="center" cursor="auto" verticalAlign="middle"/>
              </Band>
              <Band id="body">
                <Cell displaytype="checkboxcontrol" edittype="checkbox" textAlign="center" checkboxtruevalue="Y" checkboxfalsevalue="N" text="bind:CHK"/>
                <Cell col="1" text="bind:PRODUCT_CODE" textAlign="center" verticalAlign="middle"/>
                <Cell col="2" text="bind:SEC_NAME" textAlign="center" verticalAlign="middle"/>
                <Cell col="3" text="bind:PRODUCT_NAME" edittype="text" tooltiptext="더블클릭 시 수정이 가능합니다." textAlign="center" verticalAlign="middle"/>
                <Cell col="4" text="bind:PRODUCT_PATH" edittype="text" textAlign="center"/>
                <Cell col="5" text="bind:PRODUCT_PRICE" edittype="text" displaytype="mask" maskeditformat="###,###,###0" textAlign="right" maskeditmaskchar="," maskeditautoselect="false" maskeditlimitbymask="none" maskedittype="number" tooltiptext="더블클릭 시 수정이 가능합니다." verticalAlign="middle"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Button id="btn_del" taborder="5" text="삭제" width="70" height="30" right="1.85%" bottom="Div00:5" cssclass="btn_del" onclick="btn_del_onclick"/>
        <Button id="btn_save" taborder="4" text="저장" width="70" height="30" right="btn_del:5" bottom="Div00:5" cssclass="btn_save" onclick="btn_save_onclick"/>
        <Button id="btn_add" taborder="3" text="신규" width="70" onclick="btn_add_onclick" right="btn_save:5" bottom="Div00:5" height="30" cssclass="btn_view"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="init_fir_code" useclientlayout="true">
        <ColumnInfo>
          <Column id="FIR_CODE" type="STRING" size="256"/>
          <Column id="FIR_NAME" type="STRING" size="256"/>
          <Column id="USE_STATUS" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="view_code" useclientlayout="true">
        <ColumnInfo>
          <Column id="SEC_CODE" type="STRING" size="256"/>
          <Column id="SEC_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_PRICE" type="INT" size="256"/>
          <Column id="PRODUCT_CODE" type="STRING" size="256"/>
          <Column id="CHK" type="STRING" size="256"/>
          <Column id="PRODUCT_PATH" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="fir_category_select" useclientlayout="true">
        <ColumnInfo>
          <Column id="FIR_CODE" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="sec_code" useclientlayout="true">
        <ColumnInfo>
          <Column id="SEC_CODE" type="STRING" size="256"/>
          <Column id="SEC_NAME" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="choice_sec_code" useclientlayout="true">
        <ColumnInfo>
          <Column id="SEC_CODE" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <Dataset id="del_date" useclientlayout="true">
        <ColumnInfo>
          <Column id="PRODUCT_CODE" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="save_date" useclientlayout="true">
        <ColumnInfo>
          <Column id="PRODUCT_CODE" type="STRING" size="256"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_PRICE" type="STRING" size="256"/>
          <Column id="PRODUCT_PATH" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="message" useclientlayout="true">
        <ColumnInfo>
          <Column id="num" type="INT" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row/>
        </Rows>
      </Dataset>
      <FileDialog id="FileDialog00" onclose="FileDialog00_onclose"/>
      <FileUpTransfer id="FileUpTransfer00" onsuccess="FileUpTransfer00_onsuccess"/>
      <Dataset id="paging">
        <ColumnInfo>
          <Column id="page" type="INT" size="256"/>
          <Column id="start" type="INT" size="256"/>
          <Column id="end" type="INT" size="256"/>
          <Column id="pagecount" type="INT" size="256"/>
          <Column id="pagesize" type="INT" size="256"/>
          <Column id="nextpage" type="INT" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="view_dtl" useclientlayout="true">
        <ColumnInfo>
          <Column id="SEC_CODE" type="STRING" size="256"/>
          <Column id="SEC_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_PRICE" type="INT" size="256"/>
          <Column id="PRODUCT_CODE" type="STRING" size="256"/>
          <Column id="CHK" type="STRING" size="256"/>
          <Column id="PRODUCT_PATH" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Script type="xscript5.1"><![CDATA[include "Base::check_sort.xjs";

//화면 시작 시
var g_row = 0;
this.BookCafe_ProductManagemnet_Modify_oninit = function(obj:nexacro.Form,e:nexacro.EventInfo)
{	
	
	this.check_sort(this.Grid00);

	this.sec_category.set_enable(false)// 중분류 카테고리 잠그기

	//대분류 카테고리 가져오기
	
	var id = "init_fir_code"
	var url = "svc::init_fir_code.do";
	var set = ""; 
	var get = "init_fir_code = init_fir_code";
	var arg = "";
	var callback = "fn_category";
	
	this.transaction(id, url, set, get, arg, callback);
		
		var id = "view_code";
		var url = "svc::view_code.do";
		var set = "";
		var get = "view_code = view_code";
		var arg = "";
		var callback = "fn_category";
		
		this.transaction(id, url, set, get, arg, callback);
		
	//페이징 정보  page : 현재 페이지 pagesize : 한 페이지에 보여줄 row갯수
	this.pageinit(1,20); 
}


//대분류 카테고리 선택 시
this.fir_category_onitemchanged = function(obj:nexacro.Combo,e:nexacro.ItemChangeEventInfo)
{
	this.sec_category.set_enable(true) // 중분류 카테고리 열기
	if(this.fir_category.value == "fir_000"){
	this.sec_category.set_value(null)
	this.sec_category.set_enable(false)
	}else {
	this.sec_category.set_enable(true)
	}


	
	var select_category = this.fir_category.value;
	this.fir_category_select.setColumn(0,"FIR_CODE",select_category)
	
	var id = "fir_category_select"
	var url = "svc::fir_category_select.do";
	var set = "fir_category_select = fir_category_select"; 
	var get = "view_code = fir_category_select";
	var arg = "";
	var callback = "fn_category";
	
	this.transaction(id, url, set, get, arg, callback)
	
	
	var id = "select_sec_code"
	var url = "svc::select_sec_code.do";
	var set = "fir_category_select = fir_category_select";
	var get = "sec_code = sec_code";
	var arg = "";
	var callback = "fn_category";
			
	this.transaction(id, url, set, get, arg, callback)


}

//신규 등록버튼 클릭 시
this.btn_add_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
        var objChildFrame = new ChildFrame();
						// 팝업명 ,		상,하,좌,우, 좌측앵커, 우측앵커, 팝업할 xfdl
        objChildFrame.init("Product_popup", 0, 0, 400, 350, null, null, "FrameBase::BookCafe_AddProduct_popup.xfdl");
        objChildFrame.set_dragmovetype("all"); // 마우스 드래그
        objChildFrame.set_openalign("center middle"); // 화면 위치 
		objChildFrame.set_resizable(false); // 화면 크기 조절
		
        objChildFrame.showModal(this.getOwnerFrame(), null, this, "");
    } 
	

//중분류 카테고리 선택시
this.sec_category_onitemchanged = function(obj:nexacro.Combo,e:nexacro.ItemChangeEventInfo)
{
	var sec_code = this.sec_category.value
	this.choice_sec_code.setColumn(0,"SEC_CODE",sec_code)
	
			id = "choice_sec_code"
			url = "svc::choice_sec_code.do";
			set = "choice_sec_code = choice_sec_code";
			get = "view_code = view_code";
			arg = "";
			callback = "fn_category";
			
			this.transaction(id, url, set, get, arg, callback)
	
};


//저장 클릭 시 
this.btn_save_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{	
 	var num = 0;
 	for(i = 0; i < this.view_code.rowcount; i++){
		if(this.view_code.getColumn(i,"CHK") == "Y"){
		trace("꼽")
 	var code =	this.view_code.getColumn(i,"PRODUCT_CODE")
 	var name =	this.view_code.getColumn(i,"PRODUCT_NAME")
 	var price = this.view_code.getColumn(i,"PRODUCT_PRICE")
	var path = this.view_code.getColumn(i,"PRODUCT_PATH")
 
 		
 		this.save_date.addRow();
 		
 		this.save_date.setColumn(num,"PRODUCT_CODE",code)
 		this.save_date.setColumn(num,"PRODUCT_NAME",name)
 		this.save_date.setColumn(num,"PRODUCT_PRICE",price)
		this.save_date.setColumn(num,"PRODUCT_PATH", path)
 		num++;
		trace(num)
 	}; 
 	}; // for 끝
	
 	if(this.save_date.getRowCount() == 0){
 		alert("수정하실 내역이없습니다.")
		this.view_code.reset();
 		return false
 	}
 	
 	var id = "modi"
 	var url  = "svc::modi.do"
 	var set = "save_date = save_date:u"
 	var get = "message = message"
 	var arg = ""
 	var	callback = "fn_category";
 			
 	this.transaction(id, url, set, get, arg, callback)
	
	//새로운 이미지 저장
	this.FileUpTransfer00.upload("svc::upload_modi.do")
};


//삭제 버튼
this.btn_del_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{	
var num = 0 ;
	var con = this.confirm("정말 삭제 하시겠습니까?")
	
	if(con == true){

	//그리드의 전체 숫자만큼 반복 
	for(i = 0; i < this.view_code.getRowCount(); i++){

			// 걔 중 체크항목을 확인하고
			if(this.view_code.getColumn(i,"CHK") == "Y"){ // 체크항목이 존재한다면
				
				this.del_date.addRow()// 데이터셋에 공간을 만들고
			
				//삭제값만 dataset에 저장
				var code = this.view_code.getColumn(i,"PRODUCT_CODE")//체크된 값의 코드를 가져옴
				this.del_date.setColumn(num,"PRODUCT_CODE",code)// 그리고 저장
			num++;
	
		}
	
	
	
	}
		if(this.del_date.getRowCount() == 0){
		
			alert("제품을 선택해주세요")
			return false;
			
	
		}else {
			alert(this.del_date.saveXML())
			var id = "del_date"
			var url = "svc::del_date.do";
			var set = "del_date = del_date";
			var get = "message = message";
			var arg = "";
			var	callback = "fn_category";
			
			this.transaction(id, url, set, get, arg, callback)
		
		
		
		}
	}


};





//그리드 더블클릭
this.Grid00_oncelldblclick = function(obj:nexacro.Grid,e:nexacro.GridClickEventInfo)
{
	this.view_code.setColumn(e.row,"CHK","Y");//더블클릭한 cell의 체크박스 체크표시로 전환
	
	if(e.cell == 4){

		g_row = e.row

			this.FileDialog00.open('이미지수정', 1);
			
/*
"FileDialog.LOAD" 또는 1 설정 시 한 개 파일을 읽을 수 있는 FileDialog 가 표시됩니다.
"FileDialog.SAVE" 또는 2 설정 시 한 개 파일을 쓸 수 있는 FileDialog 가 표시됩니다.
"FileDialog.MULTILOAD" 또는 3 설정 시 여러개의 파일을 읽을 수 있는 FileDialog 가 표시됩니다.
"FileDialog.SELFOLDER" 또는 4 설정 시 폴더를 선택할 수 있는 FileDialog 가 표시됩니다.
*/



	}



};
this.FileDialog00_onclose = function(obj:nexacro.FileDialog,e:nexacro.FileDialogEventInfo)
{
	var path;
	var presentpath = "C:\\Users\\hcnc\\git\\TeamB\\src\\main\\webapp\\images\\"; //기존 이미지 저장경로
	
        // 선택된 파일들의 경로 가져오기
        var path = e.virtualfiles.map(function(file) {
            return file.path;	
        });

	if(path == presentpath){ //기존 이미지 파일이면
		
	// 기존 것은 변경없이 그대로 값을 보내서 수정하기.
	img_name = e.virtualfiles[0].filename // 파일이름
	img_length = e.virtualfiles[0].filename.length; // 파일이름의 길이
	this.view_code.setColumn(g_row,"PRODUCT_PATH",img_name)
	
	
	}else{//새로운 이미지이면
		
		 var objDate1 = new nexacro.Date()

		var y = objDate1.getYear(); //년
		var m = objDate1.getMonth()+1; //월
		var d = objDate1.getDate(); //일
		var s = objDate1.getSeconds();//시
		var day =y+ "-" + m + "-" + d +"-" +s;
		
	img_name = e.virtualfiles[0].filename // 파일이름
	
	var type_num =  img_name.lastIndexOf(".");
	var type = img_name.substring(type_num)
	var name = img_name.substring(0,type_num)
	var full_date = name + day + type

	this.FileUpTransfer00.addFile("images/"+full_date, e.virtualfiles[0])

	this.view_code.setColumn(g_row,"PRODUCT_PATH","images/"+full_date)
	
	}


};


//카테고리 콜백 함수
this.fn_category = function(id, code, message){

	this.message.reset()
	
	if(code == 0){
			switch(id) {
			case "fir_category_select":
				
				if(this.sec_code.getColumn(0,"SEC_NAME") == "전체"){
					this.sec_code.deleteRow(0)
				}
				var div = this.components['pagediv'];
				if(div != null)
					div.destroy();
				this.setPaging(this.view_code,this.Grid00);
				break;
				
				case "modi":
				var count = this.message.getColumn(0,"num");
				alert(count + "건 수정되었습니다.")
				this.reload();
				break;
				
				case "del_date":
		
				var count = this.message.getColumn(0,"num");
				alert(count + "건 삭제되었습니다.")
				this.reload();
				break;
				
				case "view_code":
				var div = this.components['pagediv'];
				if(div != null)
					div.destroy();
				this.setPaging(this.view_code,this.Grid00);
				break;
			
			}
		
		}
}

/***************************************************************************************/
								//페이징
/***************************************************************************************/
this.setPaging = function(ds,grid){
	//pagecount 세팅 (전체 페이지)
	var pagecount = parseInt(ds.rowcount / this.paging.getColumn(0,"pagesize"));
	
	if( ds.rowcount % this.paging.getColumn(0,"pagesize") > 0){
		pagecount+=1;
	}
	this.paging.setColumn(0,"pagecount",Number(pagecount));
	//div 만들어주기 
	var div = new nexacro.Div();
	div.init("pagediv",1,2,300,50); // left top width height
	this.addChild("pagediv",div);
	
	div.set_top(grid.id+":10px");
	div.set_left(( (grid.getOffsetWidth()/2+grid.getOffsetLeft()) - div.width/2)+"px");
	div.set_text("PAGEDIV");
	div.show();
	
	this.makebtn(div,pagecount);

	this.setds(ds,1);
}
this.makebtn = function(div,pagecount){
	//div 안에 버튼 만들어주기
	var leftpos =  div.getOffsetWidth()/2 - ((pagecount+4) /2 * 15)-25;
	
	var firstbtn = new nexacro.Button(); // << 버튼 만들기
	firstbtn.init("firstbtn",0,0,20, 30); // left top width height
  	firstbtn.set_left((leftpos  + "px"));
 	firstbtn.set_text("<<");
	firstbtn.set_cssclass("btn_num");	
	firstbtn.addEventHandler("onclick",this.onclick_firstbtn,this);
 	div.addChild("firstbtn",firstbtn); // div에  버튼 추가
 	firstbtn.show();
	
	leftpos += 25;
	var prevbtn = new nexacro.Button(); // <버튼 만들기
	prevbtn.init("prevbtn",0,0,10, 30); // left top width height
  	prevbtn.set_left((leftpos  + "px"));
 	prevbtn.set_text("<");
	prevbtn.set_cssclass("btn_num");	
	prevbtn.addEventHandler("onclick",this.onclick_prevbtn,this);
 	div.addChild("prevbtn",prevbtn); // div에  버튼 추가
 	prevbtn.show();
 		
 	for(var i =1; i<=pagecount; i++){
 		var btn = new nexacro.Button(); // 숫자 버튼 만들기
 		btn.init("pagebtn"+i,0,0,10, 30); // left top width height
		leftpos += 15;
 		btn.set_left(leftpos + "px");
 		btn.set_text(i);
		btn.set_cssclass("btn_num");
		btn.addEventHandler("onclick",this.onclick_pagebtn,this);
 		div.addChild("pagebtn"+i,btn); // div에  버튼 추가
 		btn.show();
 	}
	leftpos += 15;
	var nextbtn = new nexacro.Button(); // > 버튼 만들기
	nextbtn.init("nextbtn",0,0,10, 30); // left top width height
  	nextbtn.set_left((leftpos  + "px"));
 	nextbtn.set_text(">");
	nextbtn.set_cssclass("btn_num");
	nextbtn.addEventHandler("onclick",this.onclick_nextbtn,this);
 	div.addChild("nextbtn",nextbtn); // div에  버튼 추가
 	nextbtn.show();
	
	leftpos += 15;
	
	var endbtn = new nexacro.Button(); // >> 버튼 만들기
	endbtn.init("endbtn",0,0,20, 30); // left top width height
  	endbtn.set_left((leftpos  + "px"));
 	endbtn.set_text(">>");
	endbtn.set_cssclass("btn_num");
	endbtn.addEventHandler("onclick",this.onclick_endbtn,this);
 	div.addChild("endbtn",endbtn); // div에  버튼 추가
 	endbtn.show();
};

this.pageinit = function(page, pagesize){ // 페이징 세팅
	this.paging.addRow();
	this.paging.setColumn(0,"page",page); //현재 페이지
	this.paging.setColumn(0,"pagesize",pagesize); // 한페이지에 노출될 row 수
}
this.setpagediv = function(grid){
	var div = this.components['pagediv'];
	div.set_left( ((grid.getOffsetWidth()/2+grid.getOffsetLeft()) - div.width/2)+"px");
};
this.setds = function(ds,page){ //ds를 페이징처리해서 보여줄것들만 보여줌
	var pagesize = this.paging.getColumn(0,"pagesize");
	
	if(ds.rowcount == 0){
		this.paging.setColumn(0,"page",1);
		return;
	}
	this.view_dtl.set_enableevent(false);
	this.view_dtl.clearData();
	if(page == this.paging.getColumn(0,"pagecount")){
		for(var i = pagesize*(page-1) ; i<ds.rowcount; i++){
			var idx = this.view_dtl.addRow();
			this.view_dtl.copyRow(idx,ds,i);
		}
	}else{
		for(var i = pagesize*(page-1) ; i<pagesize*page-1; i++){
			var idx = this.view_dtl.addRow();
			this.view_dtl.copyRow(idx,ds,i);
		}
	}
	
	this.view_dtl.set_enableevent(true);
	this.paging.setColumn(0,"page",page);
};

//버튼 클릭 이벤트
this.onclick_firstbtn = function(obj:nexacro.Button){
	var ds = this.view_code; //수정
	this.setds(ds,1);
};
this.onclick_prevbtn = function(obj:nexacro.Button){
	var ds = this.view_code; //수정
	var prevpage = this.paging.getColumn(0,"page")-1;
	if(prevpage <= 1)
		this.setds(ds,1);
	else
		this.setds(ds,prevpage);
};
this.onclick_nextbtn = function(obj:nexacro.Button){
	var ds = this.view_code; //수정
	var nextpage = this.paging.getColumn(0,"page")+1;
	if(nextpage >= this.paging.getColumn(0,"pagecount"))
		this.setds(ds,this.paging.getColumn(0,"pagecount"));
	else
		this.setds(ds,nextpage);
};
this.onclick_endbtn = function(obj:nexacro.Button){
	var ds = this.view_code; //수정
	this.setds(ds,this.paging.getColumn(0,"pagecount"));
};
this.onclick_pagebtn = function(obj:nexacro.Button){
//버튼 이벤트
	this.setds(this.view_code,obj.text); //수정
};
this.Grid00_onsize = function(obj:nexacro.Grid,e:nexacro.SizeEventInfo)
{
	this.setpagediv(obj);
	//ss = 23;
	//this.paging.setColumn(0,"pagesize",ss);
	//this.setds(obj.getBindDataset(),this.paging.getColumn(0,"page"));
};


]]></Script>
    <Bind>
      <BindItem id="item0" compid="fir_category" propid="text" datasetid="init_fir_code" columnid="FIR_NAME"/>
      <BindItem id="item1" compid="sec_category" propid="text" datasetid="sec_set" columnid="SEC_NAME"/>
    </Bind>
  </Form>
</FDL>
