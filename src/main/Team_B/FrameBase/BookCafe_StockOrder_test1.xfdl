<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="주문관리" width="1080" height="720" titletext="재고관리" oninit="주문관리_oninit" onload="주문관리_onload">
    <Layouts>
      <Layout height="720" mobileorientation="landscape" width="1080">
        <Static id="Static00" taborder="0" text="재고/발주 관리" left="20" top="20" width="210" onclick="Static00_onclick" cssclass="title" height="37"/>
        <Grid id="Grid00" taborder="1" left="1.76%" top="175" height="235" autofittype="col" binddataset="stock_grid1" onheadclick="stock01_div_Grid00_onheadclick" right="1.76%">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="117"/>
                <Column size="112"/>
                <Column size="108"/>
                <Column size="40"/>
                <Column size="61"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="메뉴"/>
                <Cell col="1" text="메뉴코드"/>
                <Cell col="2" text="재고"/>
                <Cell col="3" text="bind:PRODUCT_CHECK" displaytype="checkboxcontrol" edittype="checkbox" checkboxfalsevalue="0" checkboxtruevalue="1"/>
                <Cell col="4" text="발주수량"/>
              </Band>
              <Band id="body">
                <Cell text="bind:PRODUCT_NAME" textAlign="center"/>
                <Cell col="1" text="bind:PRODUCT_CODE" textAlign="center"/>
                <Cell col="2" displaytype="decoratetext" edittype="none" textAlign="center" text="expr:PRODUCT_QUANTITY &lt; 10 ? '&lt;fc v=\&quot;red\&quot;&gt;' + PRODUCT_QUANTITY + '&lt;/fc&gt;' : '&lt;fc v=\&quot;black\&quot;&gt;' + PRODUCT_QUANTITY + '&lt;/fc&gt;'"/>
                <Cell col="3" displaytype="checkboxcontrol" edittype="checkbox" text="bind:PRODUCT_CHECK" checkboxfalsevalue="0" checkboxtruevalue="1"/>
                <Cell col="4" edittype="text" textAlign="center"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Grid id="Grid00_00" taborder="2" left="1.76%" top="470" height="230" binddataset="stock_grid2" autofittype="col" right="1.76%">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="54"/>
                <Column size="104"/>
                <Column size="70"/>
                <Column size="74"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="메뉴"/>
                <Cell col="1" text="발주수량"/>
                <Cell col="2" text="발주일자"/>
                <Cell col="3" text="신청자"/>
                <Cell col="4" text="입고확인"/>
              </Band>
              <Band id="body">
                <Cell text="bind:PRODUCT_NAME"/>
                <Cell col="1" text="bind:STOCK_ORDER_QUANTITY"/>
                <Cell col="2" text="bind:STOCK_ORDER_DATE"/>
                <Cell col="3" text="bind:ADMIN_CODE"/>
                <Cell col="4"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Div id="Div00" taborder="3" left="20" top="Static00:5" height="45" text="" background="#FAEBD7" right="20">
          <Layouts>
            <Layout/>
          </Layouts>
        </Div>
        <Button id="Button02" taborder="4" text="조회하기" left="990" width="70" cssclass="btn_dafault" height="30" bottom="Div00:5"/>
        <Button id="Button00" taborder="5" text="발주신청" left="915" width="70" height="30" onclick="stock01_div_Div00_Button00_onclick" cssclass="btn_dafault" bottom="Grid00:5"/>
        <Combo id="Combo02" taborder="6" text="카테고리" left="291" top="70" width="110" height="30" value="" index="-1" onitemchanged="stock01_div_Div00_Combo03_onitemchanged"/>
        <Button id="Button_EX_00" taborder="7" text="엑셀" left="990" cssclass="btn_dafault" height="30" bottom="Grid00:5" right="1.85%"/>
        <Button id="Button_EX_01" taborder="8" text="엑셀" left="990" cssclass="btn_dafault" height="30" bottom="Grid00_00:5" right="1.85%"/>
        <Static id="Static01" taborder="11" text="메뉴" left="36" top="77" width="24" height="14"/>
        <Combo id="Combo00" taborder="9" text="Combo00" left="Static01:5" top="70" width="110" height="30"/>
        <Combo id="Combo01" taborder="10" text="Combo01" left="178" top="70" width="110" height="30"/>
        <Calendar id="Calendar00" taborder="12" left="479" top="70" width="110" height="30"/>
        <Calendar id="Calendar01" taborder="13" left="604" top="70" width="110" height="30" onchanged="Calendar01_onchanged"/>
        <Static id="Static02" taborder="14" text="~" left="592" top="78" width="9" height="14"/>
        <Static id="Static03" taborder="15" text="날짜" height="14" top="78" width="24" left="450"/>
        <Static id="Static04" taborder="16" text="현 재고 조회" left="22" top="145" width="95" height="20" cssclass="title_sub"/>
        <Static id="Static05" taborder="17" text="발주신청서 조회" left="22" width="124" height="20" cssclass="title_sub" bottom="Grid00_00:5"/>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[/*
1. 화면 초기화
2. 발주신청서 팝업창
3. 함수
4. 체크박스
*/

/* 테스트용 버튼 */
this.stock01_div_Div00_Button01_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{	
};


include "Lib::lib_grid.xjs"

/* 1. 화면 초기화 */
this.주문관리_oninit = function(obj:nexacro.Form,e:nexacro.EventInfo)
{	
	this.gfn_setGridPopup(this.Grid00);
	
	// grid1 list 불러오기
	this.fnStockMenuList();
	
	this.stock_order_month.insertRow(0);  
	this.stock_order_month.setColumn(0, "STOCK_ORDER_MONTH", ""); //코드도 같이 채워주어야 선택 시 빈칸이 되지 않는다
    this.stock_order_month.setColumn(0, "STOCK_ORDER_MONTH", "전체보기");

};

/* 2. 발주신청서 팝업창 */
this.stock01_div_Div00_Button00_onclick = function(obj:nexacro.Button, e:nexacro.ClickEventInfo) {

	/* (1) 체크된 row갯수 count */
	//조건식을 문자열로 작성하여 전달
    var condition = "PRODUCT_CHECK" + " == '1'";
	
    // getCaseCount 메서드 호출
    var chkCnt = this.stock_grid1.getCaseCount(condition);
	alert("체크된 메뉴 갯수 : " +chkCnt);
	
	/* (2) 체크된 행이 있으면 팝업창 열기 */
    if (chkCnt > 0) {
		this.stock_order.clearData();
		
		// 세션에서 ADMIN_CODE 가져오기
		var sessionLogin = nexacro.getApplication().Session_login;
		var adminCode = sessionLogin.getColumn(0, "ADMIN_CODE");

		for(var i=0; i<this.stock_grid1.rowcount; i++){
			if(this.stock_grid1.getColumn(i, "PRODUCT_CHECK") == "1"){
				var row = this.stock_order.addRow();
				//dataset에 ADMIN_CODE 추가
				this.stock_order.setColumn(row,0,adminCode);
				this.stock_order.copyRow(row, this.stock_grid1, i);
			}
		}
		
		//확인용
		alert(this.stock_order.saveXML());
		/*alert(this.stock_order.getColumn(0,"ADMIN_CODE"));*/
		
		/*데이터 보내기
		var objParam = { PRODUCT_NAME : this.stock_order.getColumn(this.stock_orderrowposition,"PRODUCT_NAME"),
 						 PRODUCT_CODE : this.stock_order.getColumn(this.stock_orderrowposition,"PRODUCT_CODE")};
		*/
		var objParam = { param :this.stock_order }
		
		alert(objParam);

        var objChildFrame = new ChildFrame();
		
        objChildFrame.init("stock_order_popup", 0, 0, 400, 350, null, null, "FrameBase::BookCafe_StockOrder_popup.xfdl");
        objChildFrame.set_dragmovetype("all");
        objChildFrame.set_openalign("center middle");
		objChildFrame.set_resizable(false);
		
        objChildFrame.showModal(this.getOwnerFrame(), objParam, this, "fn_popupCallback");
    } else {
        this.alert("선택된 항목이 없습니다.");
    }	
};

/* 3. 함수 */
/* 3-1. grid1 list 불러오기*/
this.fnStockMenuList = function()
{
	var strSvcId    = "grid1MenuList";
	var strSvcUrl   = "svc::grid1MenuList.do";
	var inData      = "";
	var outData     = "stock_grid1=stock_grid1";
	var strArg      = "";
	var callBackFnc = "fnCallback";
	var isAsync     = true;

	this.transaction(strSvcId, strSvcUrl, inData, outData, strArg, callBackFnc, isAsync);
};

/* 콜백함수 */
/* 팝업창의 콜백 함수 정의 (테스트용으로 비워둠) */
this.fn_popupCallback = function(strPopupID, strReturn)
{
    if(strReturn == undefined){
        return;
    }

    if(strPopupID == "stock_order_popup"){
        this.alert("Return Value: " + strReturn);
    }
};


/* 4. 체크박스 전체선택/전체해제 */
this.stock01_div_Grid00_onheadclick = function(obj:nexacro.Grid,e:nexacro.GridClickEventInfo)
{
	/* 체크박스가 존재하는 3번째 column의 text값 가져오기
	== var chkOrder = obj.getCellValue(-1,3); */
	var chkOrder = obj.getCellProperty("head",3,"text");
	
	// 0:미체크 1:체크
	if(chkOrder == "1") {
		// 미체크로 초기화
		chkOrder = "0";
		obj.setCellProperty("head",3,"text",chkOrder);
		for( var i=0; i<this.stock_grid1.rowcount; i++){
			this.stock_grid1.setColumn(i,"PRODUCT_CHECK","0");
		}
	}else {
		chkOrder = "1";
		obj.setCellProperty("head",3,"text",chkOrder);
		for( var i=0; i<this.stock_grid1.rowcount; i++){
			this.stock_grid1.setColumn(i,"PRODUCT_CHECK","1");
		}
	}
};


]]></Script>
    <Objects>
      <Dataset id="stock_grid1">
        <ColumnInfo>
          <Column id="PRODUCT_NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_CODE" type="STRING" size="256"/>
          <Column id="PRODUCT_QUANTITY" type="STRING" size="256"/>
          <Column id="PRODUCT_CHECK" type="STRING" size="256" description="발주신청용체크"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="stock_grid2">
        <ColumnInfo>
          <Column id="PRODUCT_CODE" type="STRING" size="256" description="메뉴코드"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256" description="메뉴명"/>
          <Column id="STOCK_ORDER_DATE" type="STRING" size="256" description="발주일자"/>
          <Column id="STOCK_ORDER_QUANTITY" type="STRING" size="256" description="발주수량"/>
          <Column id="ADMIN_CODE" type="STRING" size="256" description="관리자 코드"/>
          <Column id="STOCK_ORDER_STATUS" type="STRING" size="256" description="발주현황"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="stock_order_month">
        <ColumnInfo>
          <Column id="STOCK_ORDER_MONTH" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="STOCK_ORDER_MONTH">01월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">02월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">03월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">04월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">05월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">06월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">07월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">08월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">09월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">10월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">11월</Col>
          </Row>
          <Row>
            <Col id="STOCK_ORDER_MONTH">12월</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="stock_grid3">
        <ColumnInfo>
          <Column id="PRODUCT_NAME" type="STRING" size="256" description="메뉴명"/>
          <Column id="PRODUCT_CODE" type="STRING" size="256" description="메뉴코드"/>
          <Column id="STOCK_IN_QUANTITY" type="STRING" size="256" description="입고"/>
          <Column id="STOCK_OUT_QUANTITY" type="STRING" size="256" description="출고"/>
          <Column id="STOCK_DATE" type="STRING" size="256" description="날짜"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="stock_order">
        <ColumnInfo>
          <Column id="ADMIN_CODE" type="STRING" size="256" description="관리자 코드"/>
          <Column id="STOCK_ORDER_CODE" type="STRING" size="256" description="발주신청서 코드"/>
          <Column id="PRODUCT_CODE" type="STRING" size="256" description="음식코드"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256" description="음식명"/>
          <Column id="PRODUCT_QUANTITY" type="STRING" size="256"/>
          <Column id="STOCK_ORDER_QUANTITY" type="STRING" size="256" description="발주수량"/>
          <Column id="STOCK_ORDER_DATE" type="STRING" size="256" description="발주일자"/>
          <Column id="STOCK_ORDER_STATUS" type="STRING" size="256" description="발주현황"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
